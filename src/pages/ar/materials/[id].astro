---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Header from '../../../components/layout/Header.astro';
import Footer from '../../../components/layout/Footer.astro';
import MaterialDetailHero from '../../../components/sections/MaterialDetailHero.astro';
import MaterialDetailContent from '../../../components/sections/MaterialDetailContent.astro';
import RelatedMaterials from '../../../components/sections/RelatedMaterials.astro';
import { getTranslations } from '../../../i18n/utils';
import { getAllMaterials, getMaterialById, type SanityMaterial } from '../../../lib/queries/materials';
import { getLocalizedValue, type Language } from '../../../lib/sanity';
import { urlFor } from '../../../lib/sanityImage';

// Generate static paths for all materials
export async function getStaticPaths() {
  const materials = await getAllMaterials();

  return materials.map((material) => ({
    params: { id: material.internalId?.current || material._id },
    props: { materialId: material.internalId?.current || material._id },
  }));
}

const lang = 'ar';
const { id } = Astro.params;
const { materialId } = Astro.props;

// Fetch material from Sanity
const material = await getMaterialById(materialId);

// Fallback to i18n translations if Sanity data is incomplete
const t = getTranslations(lang);

// Get localized content from Sanity or fallback to i18n
const materialName = getLocalizedValue(material?.name, lang as Language) ||
  t.materials.items[id as keyof typeof t.materials.items]?.name ||
  id;

const materialDescription = getLocalizedValue(material?.description, lang as Language) ||
  t.materials.items[id as keyof typeof t.materials.items]?.description ||
  '';

// Get image URL - prefer Sanity, fallback to static
const heroImageUrl = material?.mainImage?.asset
  ? urlFor(material.mainImage).width(1920).height(800).format('webp').url()
  : `/materials/${id}/${id}.jpg`;

const category = material?.category || 'classic';
---

<BaseLayout
  title={`${materialName} | ${t.meta.title}`}
  description={materialDescription.slice(0, 160)}
  lang={lang}
>
  <Header pageType="project" />

  <main>
    <MaterialDetailHero
      heroImage={heroImageUrl}
      materialName={materialName}
    />

    <MaterialDetailContent
      artTitle={materialName}
      description={materialDescription}
      price={material?.price}
      priceUnit={material?.priceUnit}
    />

    <RelatedMaterials
      currentMaterialId={id}
      currentCategory={category}
    />
  </main>

  <Footer />
</BaseLayout>
