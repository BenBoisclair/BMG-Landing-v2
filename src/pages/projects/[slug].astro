---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import ProjectDetailHero from '../../components/sections/ProjectDetailHero.astro';
import ProjectDetailContent from '../../components/sections/ProjectDetailContent.astro';
import ProjectDetailGallery from '../../components/sections/ProjectDetailGallery.astro';
import RelatedProjects from '../../components/sections/RelatedProjects.astro';
import { getTranslations, defaultLang } from '../../i18n/utils';
import { getAllProjects, getProjectById, type SanityProject } from '../../lib/queries/projects';
import { getLocalizedValue, type Language } from '../../lib/sanity';
import { urlFor } from '../../lib/sanityImage';

// Generate static paths for all projects
export async function getStaticPaths() {
  const projects = await getAllProjects();

  return projects.map((project) => ({
    params: { slug: project.internalId?.current || project._id },
    props: { projectId: project.internalId?.current || project._id },
  }));
}

const { slug } = Astro.params;
const { projectId } = Astro.props;

// Fetch project from Sanity
const project = await getProjectById(projectId);

// Fallback to i18n translations if Sanity data is incomplete
const t = getTranslations(defaultLang);
const lang = defaultLang as Language;

// Get localized content from Sanity or fallback to i18n
const projectName = getLocalizedValue(project?.name, lang) ||
  t.project.projects[slug as keyof typeof t.project.projects]?.name ||
  slug;

const artTitle = getLocalizedValue(project?.artTitle, lang) ||
  t.project.projects[slug as keyof typeof t.project.projects]?.artTitle ||
  projectName;

const description = getLocalizedValue(project?.description, lang) ||
  t.project.projects[slug as keyof typeof t.project.projects]?.description ||
  '';

const material = getLocalizedValue(project?.material, lang) ||
  t.project.projects[slug as keyof typeof t.project.projects]?.material ||
  '';

const customer = project?.customer ||
  t.project.projects[slug as keyof typeof t.project.projects]?.customer ||
  '';

const location = getLocalizedValue(project?.location, lang) ||
  t.project.projects[slug as keyof typeof t.project.projects]?.location ||
  '';

// Get image URLs
const heroImageUrl = project?.heroImage?.asset
  ? urlFor(project.heroImage).width(1920).height(800).format('webp').url()
  : project?.mainImage?.asset
    ? urlFor(project.mainImage).width(1920).height(800).format('webp').url()
    : '/images/placeholder.jpg';

// Get gallery images
const galleryImages = project?.gallery?.length
  ? project.gallery.map(img => urlFor(img).width(800).height(600).format('webp').url())
  : [];
---

<BaseLayout
  title={`${projectName} | ${t.meta.title}`}
  description={description.slice(0, 160)}
  lang={defaultLang}
>
  <Header pageType="project" />

  <main>
    <ProjectDetailHero
      heroImage={heroImageUrl}
      projectName={projectName}
    />

    <ProjectDetailContent
      artTitle={artTitle}
      description={description}
      material={material}
      customer={customer}
      location={location}
    />

    <ProjectDetailGallery
      images={galleryImages}
      projectName={projectName}
    />

    <RelatedProjects currentProjectId={slug} />
  </main>

  <Footer />
</BaseLayout>
