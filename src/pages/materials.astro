---
/**
 * Materials Page
 *
 * Displays the materials catalog with tab-based filtering by grade.
 * Users can switch between A++ (Semi-Precious), A+ (Luxury), and A (Classic) grades.
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import MaterialsTabs from '../components/ui/MaterialsTabs.astro';
import MaterialsFilter from '../components/ui/MaterialsFilter.astro';
import MaterialsGrid from '../components/sections/MaterialsGrid.astro';
import { useI18n } from '../i18n/utils';
import { getAllMaterials, type SanityMaterial } from '../lib/queries/materials';
import { getLocalizedValue, type Language } from '../lib/sanity';

const { lang, t } = useI18n(Astro.url);

// Fetch materials from Sanity
const sanityMaterials = await getAllMaterials();

// Group materials by category
const materialsByCategory = {
  premium: sanityMaterials.filter(m => m.category === 'premium'),
  luxury: sanityMaterials.filter(m => m.category === 'luxury'),
  classic: sanityMaterials.filter(m => m.category === 'classic'),
};

// Prepare categories data for tabs
const categories = [
  { id: 'premium', tier: 'A++', label: t.materials.categoryLabels?.premium || 'Premium' },
  { id: 'luxury', tier: 'A+', label: t.materials.categoryLabels?.luxury || 'Luxury' },
  { id: 'classic', tier: 'A', label: t.materials.categoryLabels?.classic || 'Classic' },
];

// Transform Sanity materials to format expected by MaterialsGrid
function transformMaterials(materials: SanityMaterial[], category: string) {
  return materials.map(m => ({
    id: m.internalId?.current || m._id,
    image: m.mainImage, // Will be processed by MaterialsGrid using Sanity image URL
    folder: m.internalId?.current || m._id,
    category,
    name: getLocalizedValue(m.name, lang as Language) || m.internalId?.current || 'Material',
    sanityImage: m.mainImage, // Keep original Sanity image reference
  }));
}
---

<BaseLayout
  title={`${t.materials.pageTitle} | ${t.meta.title}`}
  description={t.meta.description}
  lang={lang}
>
  <Header pageType="project" />

  <main class="pt-28 pb-16 bg-white min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Top Navigation Bar -->
      <div class="flex justify-center items-center mb-10 relative">
        <MaterialsTabs categories={categories} />

        <!-- Filter Button - Positioned absolutely on the right -->
        <div class="absolute right-0 top-1/2 -translate-y-1/2 hidden lg:block">
          <MaterialsFilter />
        </div>
      </div>

      <!-- Mobile Filter Button -->
      <div class="flex justify-end mb-6 lg:hidden">
        <MaterialsFilter />
      </div>

      <!-- Category Label -->
      <h2
        class="category-label text-lg font-semibold text-[#293039] mb-6"
        data-default-label={categories[0]?.label}
      >
        {categories[0]?.label}
      </h2>

      <!-- Materials Grids (one per category, hidden/shown via JS) -->
      {categories.map((category, index) => (
        <div
          class:list={[
            "materials-panel",
            index !== 0 && "hidden"
          ]}
          id={`panel-${category.id}`}
          data-category={category.id}
          role="tabpanel"
          aria-labelledby={`tab-${category.id}`}
        >
          <MaterialsGrid
            materials={transformMaterials(materialsByCategory[category.id as keyof typeof materialsByCategory], category.id)}
            categoryId={category.id}
          />
        </div>
      ))}
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  // Handle tab changes - query DOM inside handler to avoid stale references
  function handleTabChange(e) {
    const { categoryId, categoryLabel: label } = e.detail;
    const categoryLabelEl = document.querySelector('.category-label');
    const panels = document.querySelectorAll('.materials-panel');

    // Update category label
    if (categoryLabelEl) {
      categoryLabelEl.textContent = label;
    }

    // Show/hide panels
    panels.forEach((panel) => {
      const panelCategory = panel.getAttribute('data-category');
      if (panelCategory === categoryId) {
        panel.classList.remove('hidden');
      } else {
        panel.classList.add('hidden');
      }
    });
  }

  // Handle filter changes (placeholder - can be expanded later)
  function handleFilterChange(e) {
    const { filterId } = e.detail;
    console.log('Filter changed:', filterId);
    // Future: Implement actual filtering logic
  }

  // Remove existing listeners to prevent duplicates, then add fresh ones
  document.removeEventListener('materials-tab-change', handleTabChange);
  document.removeEventListener('materials-filter-change', handleFilterChange);
  document.addEventListener('materials-tab-change', handleTabChange);
  document.addEventListener('materials-filter-change', handleFilterChange);
</script>

<style>
  .category-label {
    font-family: 'Inter', sans-serif;
    letter-spacing: -0.33px;
  }
</style>
