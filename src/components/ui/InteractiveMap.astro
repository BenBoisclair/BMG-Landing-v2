---
// Interactive World Map Component
// Displays a hexagonal world map with hoverable country regions
// The colored hexagons in the SVG are selectable countries

import countriesData from '../../data/countries.json';

interface Country {
  id: string;
  name: string;
  color: string;
  x: number;
  y: number;
  radius: number;
  description?: string;
}

const countries: Country[] = countriesData.countries;
const countriesJson = JSON.stringify(countries);
---

<div class="interactive-map-wrapper">
  <div class="interactive-map-container relative">
    <!-- Map SVG Container -->
    <div id="map-svg-container" class="rounded-2xl overflow-hidden">
      <img
        id="map-placeholder"
        src="/images/Landing/Map.svg"
        alt="World map showing global reach"
        class="w-full h-auto opacity-0 absolute"
      />
      <div id="map-svg-wrapper" class="relative w-full"></div>
    </div>

    <!-- Tooltip -->
    <div
      id="map-tooltip"
      class="absolute pointer-events-none bg-white px-4 py-3 rounded-xl shadow-xl opacity-0 transition-all duration-200 z-50 border border-gray-100"
      style="transform: translate(-50%, -100%); margin-top: -12px;"
    >
      <div class="flex items-center gap-2">
        <span id="tooltip-color-dot" class="w-3 h-3 rounded-full flex-shrink-0"></span>
        <span id="tooltip-text" class="font-semibold text-sm whitespace-nowrap" style="color: #2C266C;"></span>
      </div>
      <p id="tooltip-description" class="text-xs text-gray-500 mt-1 whitespace-nowrap"></p>
    </div>

    <!-- Interactive overlay for country regions -->
    <svg
      id="map-overlay"
      class="absolute top-0 left-0 w-full h-full pointer-events-none"
      viewBox="0 0 1311 672"
      preserveAspectRatio="xMidYMid meet"
    >
      {countries.map((country) => (
        <circle
          class="country-region pointer-events-auto cursor-pointer"
          data-country-id={country.id}
          data-country-name={country.name}
          data-country-color={country.color}
          data-country-description={country.description || ''}
          cx={country.x}
          cy={country.y}
          r={country.radius}
          fill="transparent"
        />
      ))}
    </svg>
  </div>

  <!-- Map Legend -->
  <div class="map-legend flex flex-wrap justify-center gap-4 md:gap-6 mt-6 px-4">
    <div class="legend-item flex items-center gap-2">
      <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: #392DCA;"></span>
      <span class="text-sm text-gray-600">Primary Markets</span>
    </div>
    <div class="legend-item flex items-center gap-2">
      <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: #FF881B;"></span>
      <span class="text-sm text-gray-600">Growing Markets</span>
    </div>
    <div class="legend-item flex items-center gap-2">
      <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: #E23A45;"></span>
      <span class="text-sm text-gray-600">Emerging Markets</span>
    </div>
    <div class="legend-item flex items-center gap-2">
      <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: #ACA7E9;"></span>
      <span class="text-sm text-gray-600">Partner Regions</span>
    </div>
  </div>

  <!-- Interaction hint -->
  <p class="text-center text-xs text-gray-400 mt-3">Hover over colored regions to see country details</p>
</div>

<style>
  .interactive-map-container {
    position: relative;
  }

  #map-svg-wrapper :global(svg) {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Make colored paths in SVG glow on hover */
  #map-svg-wrapper :global(path[fill="#392DCA"]),
  #map-svg-wrapper :global(path[fill="#FF881B"]),
  #map-svg-wrapper :global(path[fill="#E23A45"]),
  #map-svg-wrapper :global(path[fill="#ACA7E9"]) {
    cursor: pointer;
    transition: filter 0.2s ease, transform 0.2s ease;
  }

  #map-svg-wrapper :global(path[fill="#392DCA"]:hover),
  #map-svg-wrapper :global(path[fill="#FF881B"]:hover),
  #map-svg-wrapper :global(path[fill="#E23A45"]:hover),
  #map-svg-wrapper :global(path[fill="#ACA7E9"]:hover) {
    filter: drop-shadow(0 0 6px currentColor) brightness(1.2);
  }

  /* Subtle pulse animation for colored hexagons */
  @keyframes subtlePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
  }

  #map-svg-wrapper :global(.colored-hex) {
    animation: subtlePulse 3s ease-in-out infinite;
  }

  .country-region {
    transition: all 0.2s ease;
  }

  .country-region:hover {
    fill: rgba(255, 255, 255, 0.15);
  }

  #map-tooltip {
    backdrop-filter: blur(8px);
    background: rgba(255, 255, 255, 0.95);
  }
</style>

<script define:vars={{ countriesJson }}>
  // Parse countries data
  const countries = JSON.parse(countriesJson);

  // Color to country mapping for direct hexagon interactions
  const colorToCountries = {};
  countries.forEach(country => {
    if (!colorToCountries[country.color]) {
      colorToCountries[country.color] = [];
    }
    colorToCountries[country.color].push(country);
  });

  // Initialize map when DOM is loaded
  document.addEventListener('DOMContentLoaded', async () => {
    const mapWrapper = document.getElementById('map-svg-wrapper');
    const tooltip = document.getElementById('map-tooltip');
    const tooltipText = document.getElementById('tooltip-text');
    const tooltipDescription = document.getElementById('tooltip-description');
    const tooltipColorDot = document.getElementById('tooltip-color-dot');
    const placeholder = document.getElementById('map-placeholder');
    const container = document.querySelector('.interactive-map-container');

    if (!mapWrapper || !tooltip || !tooltipText || !container) return;

    // Helper to show tooltip
    const showTooltip = (name, color, description, event) => {
      if (tooltipText) tooltipText.textContent = name;
      if (tooltipDescription) {
        tooltipDescription.textContent = description || '';
        tooltipDescription.style.display = description ? 'block' : 'none';
      }
      if (tooltipColorDot) tooltipColorDot.style.backgroundColor = color;
      tooltip.style.opacity = '1';
      updateTooltipPosition(event);
    };

    // Helper to hide tooltip
    const hideTooltip = () => {
      tooltip.style.opacity = '0';
    };

    // Helper to update tooltip position
    const updateTooltipPosition = (event) => {
      const rect = container.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    };

    // Helper to find nearest country based on coordinates
    const findNearestCountry = (x, y) => {
      let nearest = null;
      let minDistance = Infinity;

      // Get SVG dimensions for scaling
      const svg = mapWrapper.querySelector('svg');
      if (!svg) return null;

      const svgRect = svg.getBoundingClientRect();
      const scaleX = 1311 / svgRect.width;
      const scaleY = 672 / svgRect.height;

      const scaledX = x * scaleX;
      const scaledY = y * scaleY;

      countries.forEach(country => {
        const distance = Math.sqrt(
          Math.pow(scaledX - country.x, 2) + Math.pow(scaledY - country.y, 2)
        );
        if (distance < country.radius && distance < minDistance) {
          minDistance = distance;
          nearest = country;
        }
      });

      return nearest;
    };

    try {
      // Fetch and inject SVG
      const response = await fetch('/images/Landing/Map.svg');
      const svgText = await response.text();
      mapWrapper.innerHTML = svgText;

      // Get the injected SVG element
      const svgElement = mapWrapper.querySelector('svg');
      if (svgElement) {
        svgElement.style.width = '100%';
        svgElement.style.height = 'auto';

        // Find all colored (non-white) hexagon paths and make them interactive
        const coloredColors = ['#392DCA', '#FF881B', '#E23A45', '#ACA7E9', '#EBECF7'];

        coloredColors.forEach(color => {
          const paths = svgElement.querySelectorAll(`path[fill="${color}"]`);
          paths.forEach(path => {
            path.classList.add('colored-hex');

            // Add hover events to colored hexagons
            path.addEventListener('mouseenter', (e) => {
              // Find the nearest country based on hexagon position
              const bbox = path.getBBox();
              const centerX = bbox.x + bbox.width / 2;
              const centerY = bbox.y + bbox.height / 2;

              // Find matching country
              let matchedCountry = null;
              let minDist = Infinity;

              countries.forEach(country => {
                const dist = Math.sqrt(
                  Math.pow(centerX - country.x, 2) + Math.pow(centerY - country.y, 2)
                );
                if (dist < minDist) {
                  minDist = dist;
                  matchedCountry = country;
                }
              });

              if (matchedCountry && minDist < 100) {
                showTooltip(matchedCountry.name, matchedCountry.color, matchedCountry.description, e);
              } else {
                // Show color category
                const colorNames = {
                  '#392DCA': 'Primary Market',
                  '#FF881B': 'Growing Market',
                  '#E23A45': 'Emerging Market',
                  '#ACA7E9': 'Partner Region',
                  '#EBECF7': 'Coverage Area'
                };
                showTooltip(colorNames[color] || 'Active Region', color, '', e);
              }
            });

            path.addEventListener('mousemove', updateTooltipPosition);
            path.addEventListener('mouseleave', hideTooltip);
          });
        });
      }

      // Hide placeholder
      if (placeholder) {
        placeholder.style.display = 'none';
      }
    } catch (error) {
      console.error('Failed to load map SVG:', error);
      // Show placeholder image as fallback
      if (placeholder) {
        placeholder.style.opacity = '1';
        placeholder.style.position = 'relative';
      }
    }

    // Set up tooltip interactions for country region circles
    const countryRegions = document.querySelectorAll('.country-region');

    countryRegions.forEach((region) => {
      region.addEventListener('mouseenter', (e) => {
        const name = region.getAttribute('data-country-name');
        const color = region.getAttribute('data-country-color');
        const description = region.getAttribute('data-country-description');
        if (name) {
          showTooltip(name, color || '#392DCA', description || '', e);
        }
      });

      region.addEventListener('mousemove', updateTooltipPosition);
      region.addEventListener('mouseleave', hideTooltip);

      region.addEventListener('click', (e) => {
        const countryId = region.getAttribute('data-country-id');
        const countryName = region.getAttribute('data-country-name');

        // Dispatch custom event for potential future use
        window.dispatchEvent(new CustomEvent('country-selected', {
          detail: { id: countryId, name: countryName }
        }));

        console.log(`Selected country: ${countryName}`);
      });
    });
  });
</script>
