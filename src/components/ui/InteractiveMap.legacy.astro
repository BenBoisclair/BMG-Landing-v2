---
// Interactive World Map Component
// Displays a hexagonal world map with hoverable region zones
// Uses ellipse overlays for reliable hover detection

import regionsData from '../../data/regions.json';

interface Project {
  name: string;
  description: string;
  image: string;
}

interface Region {
  id: string;
  name: string;
  cx: number;
  cy: number;
  r: number;
  project: Project;
}

const regions: Region[] = regionsData.regions;
---

<div class="interactive-map-wrapper">
  <div class="interactive-map-container relative">
    <!-- Map SVG Container -->
    <div id="map-svg-container" class="rounded-2xl overflow-hidden relative">
      <!-- Static map image -->
      <img
        id="map-image"
        src="/images/Landing/Map.svg"
        alt="World map showing global reach"
        class="w-full h-auto block"
      />
    </div>

    <!-- Project Tooltip -->
    <div
      id="map-tooltip"
      class="absolute pointer-events-none bg-white p-3 rounded-xl shadow-xl opacity-0 transition-all duration-200 z-50 border border-gray-100 max-w-[300px]"
      style="transform: translate(-50%, -100%); margin-top: -16px;"
    >
      <div class="flex items-start gap-3">
        <img
          id="tooltip-image"
          class="w-16 h-16 rounded-lg object-cover flex-shrink-0 bg-gray-100"
          alt=""
        />
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-2 mb-1">
            <span id="tooltip-region" class="text-xs text-gray-400 truncate"></span>
          </div>
          <h4 id="tooltip-project-name" class="font-semibold text-sm text-brand-primary leading-tight mb-1"></h4>
          <p id="tooltip-description" class="text-xs text-gray-500 line-clamp-2"></p>
        </div>
      </div>
    </div>

    <!-- Region overlay - circle zones for hover detection with visible indicators -->
    <svg
      id="region-overlay"
      class="absolute top-0 left-0 w-full h-full pointer-events-none"
      viewBox="0 0 1311 672"
      preserveAspectRatio="xMidYMid meet"
    >
      {regions.map((region) => (
        <g class="region-group">
          <!-- Visible indicator dot -->
          <circle
            class="region-dot"
            cx={region.cx}
            cy={region.cy}
            r="8"
            fill="#392DCA"
          />
          <!-- Invisible hover zone -->
          <circle
            class="region-zone pointer-events-auto cursor-pointer"
            data-region-id={region.id}
            data-region-name={region.name}
            data-project-name={region.project.name}
            data-project-description={region.project.description}
            data-project-image={region.project.image}
            cx={region.cx}
            cy={region.cy}
            r={region.r}
            fill="transparent"
          />
        </g>
      ))}
    </svg>
  </div>
</div>

<style>
  .interactive-map-container {
    position: relative;
  }

  /* Visible indicator dots */
  .region-dot {
    transition: all 0.2s ease;
    filter: drop-shadow(0 0 4px rgba(57, 45, 202, 0.5));
  }

  /* Region zone hover styles */
  .region-zone {
    transition: fill 0.2s ease;
  }

  .region-zone:hover {
    fill: rgba(255, 255, 255, 0.12);
  }

  /* Enlarge dot on hover */
  .region-zone:hover + .region-dot,
  .region-group:hover .region-dot {
    transform-origin: center;
    r: 12;
    filter: drop-shadow(0 0 8px rgba(57, 45, 202, 0.8));
  }

  /* Tooltip styles */
  #map-tooltip {
    backdrop-filter: blur(8px);
    background: rgba(255, 255, 255, 0.98);
  }

  /* Line clamp for description */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Tooltip image loading state */
  #tooltip-image {
    transition: opacity 0.2s ease;
  }

  #tooltip-image[src=""] {
    opacity: 0;
  }
</style>

<script>
  // Initialize map interactions
  function initMap() {
    const tooltip = document.getElementById('map-tooltip');
    const tooltipImage = document.getElementById('tooltip-image') as HTMLImageElement;
    const tooltipRegion = document.getElementById('tooltip-region');
    const tooltipProjectName = document.getElementById('tooltip-project-name');
    const tooltipDescription = document.getElementById('tooltip-description');
    const container = document.querySelector('.interactive-map-container');

    if (!tooltip || !container) return;

    // Show tooltip with project data
    const showTooltip = (regionName: string, projectData: { name: string; description: string; image: string }, event: MouseEvent) => {
      if (tooltipRegion) tooltipRegion.textContent = regionName;
      if (tooltipImage) {
        tooltipImage.src = projectData.image;
        tooltipImage.alt = projectData.name;
      }
      if (tooltipProjectName) tooltipProjectName.textContent = projectData.name;
      if (tooltipDescription) tooltipDescription.textContent = projectData.description;

      tooltip.style.opacity = '1';
      updateTooltipPosition(event);
    };

    // Hide tooltip
    const hideTooltip = () => {
      tooltip.style.opacity = '0';
    };

    // Update tooltip position relative to container
    const updateTooltipPosition = (event: MouseEvent) => {
      const rect = container.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      // Keep tooltip within bounds
      const tooltipRect = tooltip.getBoundingClientRect();
      const maxX = rect.width - tooltipRect.width / 2;
      const minX = tooltipRect.width / 2;

      const clampedX = Math.max(minX, Math.min(maxX, x));

      tooltip.style.left = `${clampedX}px`;
      tooltip.style.top = `${y}px`;
    };

    // Set up hover events for region zones
    const regionZones = document.querySelectorAll('.region-zone');

    regionZones.forEach((zone) => {
      zone.addEventListener('mouseenter', (e) => {
        const regionName = zone.getAttribute('data-region-name') || '';
        const projectData = {
          name: zone.getAttribute('data-project-name') || '',
          description: zone.getAttribute('data-project-description') || '',
          image: zone.getAttribute('data-project-image') || ''
        };

        showTooltip(regionName, projectData, e as MouseEvent);
      });

      zone.addEventListener('mousemove', (e) => {
        updateTooltipPosition(e as MouseEvent);
      });

      zone.addEventListener('mouseleave', () => {
        hideTooltip();
      });

      // Optional: Click handler for future navigation
      zone.addEventListener('click', () => {
        const regionId = zone.getAttribute('data-region-id');
        const regionName = zone.getAttribute('data-region-name');
        console.log(`Selected region: ${regionName} (${regionId})`);
      });
    });
  }

  // Run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }
</script>
