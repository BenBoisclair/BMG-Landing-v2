---
import { useI18n, getLocalizedPath } from '../../i18n/utils';
import { getAllProjects, type SanityProject } from '../../lib/queries/projects';
import { getLocalizedValue, type Language } from '../../lib/sanity';
import { urlFor } from '../../lib/sanityImage';

interface Props {
  currentProjectId: string;
  count?: number;
}

const { currentProjectId, count = 3 } = Astro.props;
const { t, lang } = useI18n(Astro.url);

// Fetch all projects from Sanity
const allProjects = await getAllProjects();

// Filter out current project and get random selection
const otherProjects = allProjects.filter(
  p => (p.internalId?.current || p._id) !== currentProjectId
);
const shuffled = otherProjects.sort(() => Math.random() - 0.5);
const relatedProjects = shuffled.slice(0, count);

// Helper to get project name
const getProjectName = (project: SanityProject): string => {
  const sanityName = getLocalizedValue(project.name, lang as Language);
  if (sanityName) return sanityName;

  const projectId = project.internalId?.current || project._id;
  const projectTranslations = t.project.projects as Record<string, { name: string }>;
  return projectTranslations[projectId]?.name || projectId;
};

// Helper to get image URL
const getImageUrl = (project: SanityProject): string => {
  if (project.mainImage?.asset) {
    return urlFor(project.mainImage).width(600).height(450).format('webp').url();
  }
  return '/images/placeholder.jpg';
};
---

<section class="py-12 lg:py-16">
  <!-- Title (centered, outside blue) -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8 text-center">
    <h2 class="text-3xl lg:text-4xl font-bold text-brand-primary uppercase tracking-tight">
      {t.projectDetail.relatedProjects}
    </h2>
  </div>

  <!-- Overlap Container -->
  <div class="relative">
    <!-- Blue Background Block (absolute positioned) -->
    <div class="blue-background-block absolute left-4 right-4 lg:left-12 lg:right-12 bg-brand-primary"></div>

    <!-- Content Wrapper (relative with cards overlapping) -->
    <div class="relative projects-wrapper">
      <!-- Cards Grid -->
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 relative z-10">
          {relatedProjects.map((project) => {
            const projectId = project.internalId?.current || project._id;
            return (
              <a
                href={getLocalizedPath(lang, `/projects/${projectId}`)}
                class="project-card block"
              >
                <div class="aspect-[4/3] overflow-hidden">
                  <img
                    src={getImageUrl(project)}
                    alt={getProjectName(project)}
                    class="w-full h-full object-cover"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
                <div class="p-4 text-center">
                  <h3 class="project-title">
                    {getProjectName(project)}
                  </h3>
                </div>
              </a>
            );
          })}
        </div>
      </div>

      <!-- Back Button (inside blue area) -->
      <div class="flex justify-center mt-12 pb-12 relative z-10">
        <a
          href={getLocalizedPath(lang, '/projects')}
          class="back-button"
        >
          <span class="rotate-180 text-lg">â†’</span>
          <span class="font-medium">{t.projectDetail.back}</span>
        </a>
      </div>
    </div>
  </div>
</section>

<style>
  .blue-background-block {
    top: 80px; /* Cards overlap by this much */
    bottom: 0;
    border-radius: 1.5rem;
  }

  .projects-wrapper {
    padding-top: 0;
    padding-bottom: 0;
  }

  .project-card {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: box-shadow 0.3s, transform 0.3s;
  }

  .project-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }

  .project-card img {
    transition: transform 0.3s;
  }

  .project-card:hover img {
    transform: scale(1.05);
  }

  .project-title {
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .back-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background-color: var(--color-accent-red);
    color: white;
    border-radius: 0.5rem;
    transition: background-color 0.3s;
  }

  .back-button:hover {
    background-color: #9a1a1e;
  }
</style>
