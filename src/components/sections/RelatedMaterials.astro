---
import { useI18n, getLocalizedPath } from '../../i18n/utils';
import { getMaterialsByCategory, getAllMaterials, type SanityMaterial } from '../../lib/queries/materials';
import { getLocalizedValue, type Language } from '../../lib/sanity';
import { urlFor } from '../../lib/sanityImage';

interface Props {
  currentMaterialId: string;
  currentCategory: string;
  count?: number;
}

const { currentMaterialId, currentCategory, count = 3 } = Astro.props;
const { t, lang } = useI18n(Astro.url);

// Fetch materials from Sanity
const sameCategoryMaterials = await getMaterialsByCategory(currentCategory as 'premium' | 'luxury' | 'classic');
const filteredSameCategory = sameCategoryMaterials.filter(
  m => (m.internalId?.current || m._id) !== currentMaterialId
);

// If not enough materials in same category, fill from other categories
let relatedMaterials: SanityMaterial[] = [...filteredSameCategory];

if (relatedMaterials.length < count) {
  const allMaterials = await getAllMaterials();
  const otherMaterials = allMaterials.filter(
    m => m.category !== currentCategory && (m.internalId?.current || m._id) !== currentMaterialId
  );
  const shuffledOthers = otherMaterials.sort(() => Math.random() - 0.5);
  relatedMaterials = [...relatedMaterials, ...shuffledOthers].slice(0, count);
} else {
  // Shuffle and take count
  relatedMaterials = relatedMaterials.sort(() => Math.random() - 0.5).slice(0, count);
}

// Helper to get material name
const getMaterialName = (material: SanityMaterial): string => {
  const sanityName = getLocalizedValue(material.name, lang as Language);
  if (sanityName) return sanityName;

  const materialId = material.internalId?.current || material._id;
  const materialTranslations = t.materials.items as Record<string, { name: string }>;
  return materialTranslations[materialId]?.name || materialId;
};

// Helper to get image URL
const getImageUrl = (material: SanityMaterial): string => {
  if (material.mainImage?.asset) {
    return urlFor(material.mainImage).width(600).height(450).format('webp').url();
  }
  const materialId = material.internalId?.current || material._id;
  return `/materials/${materialId}/${materialId}.jpg`;
};
---

<section class="py-12 lg:py-16">
  <!-- Title (centered, outside blue) -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8 text-center">
    <h2 class="text-3xl lg:text-4xl font-bold text-brand-primary uppercase tracking-tight">
      {t.materials.detail.similarMaterials}
    </h2>
  </div>

  <!-- Overlap Container -->
  <div class="relative">
    <!-- Blue Background Block (absolute positioned) -->
    <div class="blue-background-block absolute left-4 right-4 lg:left-12 lg:right-12 bg-brand-primary"></div>

    <!-- Content Wrapper (relative with cards overlapping) -->
    <div class="relative materials-wrapper">
      <!-- Cards Grid -->
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 relative z-10">
          {relatedMaterials.map((material) => {
            const materialId = material.internalId?.current || material._id;
            return (
              <a
                href={getLocalizedPath(lang, `/materials/${materialId}`)}
                class="material-card block"
              >
                <div class="aspect-[4/3] overflow-hidden">
                  <img
                    src={getImageUrl(material)}
                    alt={getMaterialName(material)}
                    class="w-full h-full object-cover"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
                <div class="p-4 text-center">
                  <h3 class="material-title">
                    {getMaterialName(material)}
                  </h3>
                </div>
              </a>
            );
          })}
        </div>
      </div>

      <!-- Back Button (inside blue area) -->
      <div class="flex justify-center mt-12 pb-12 relative z-10">
        <a
          href={getLocalizedPath(lang, '/materials')}
          class="back-button"
        >
          <span class="rotate-180 text-lg">â†’</span>
          <span class="font-medium">{t.materials.detail.back}</span>
        </a>
      </div>
    </div>
  </div>
</section>

<style>
  .blue-background-block {
    top: 80px; /* Cards overlap by this much */
    bottom: 0;
    border-radius: 1.5rem;
  }

  .materials-wrapper {
    padding-top: 0;
    padding-bottom: 0;
  }

  .material-card {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: box-shadow 0.3s, transform 0.3s;
  }

  .material-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }

  .material-card img {
    transition: transform 0.3s;
  }

  .material-card:hover img {
    transform: scale(1.05);
  }

  .material-title {
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .back-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background-color: var(--color-accent-red);
    color: white;
    border-radius: 0.5rem;
    transition: background-color 0.3s;
  }

  .back-button:hover {
    background-color: #9a1a1e;
  }
</style>
