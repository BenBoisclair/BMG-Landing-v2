---
import TestimonialCard from '../ui/TestimonialCard.astro';
import { useI18n } from '../../i18n/utils';
import Container from '../ui/Container.astro';

const { t } = useI18n(Astro.url);

const testimonials = [
  {
    name: 'Sabo Masties',
    role: 'Founder @ Rolex',
    quote: 'Yet preference connection unpleasant yet melancholy but end appearance. And excellence partiality estimating terminated day everything.',
    rating: 5,
  },
  {
    name: 'Sam',
    role: 'Founder @ Migelko',
    quote: 'Yet preference connection unpleasant yet melancholy but end appearance. And excellence partiality estimating terminated day everything.',
    rating: 5,
  },
  {
    name: 'Mansur',
    role: 'Founder @ Google',
    quote: 'Yet preference connection unpleasant yet melancholy but end appearance. And excellence partiality estimating terminated day everything.',
    rating: 5,
  },
  {
    name: 'Sarah Chen',
    role: 'CEO @ TechVentures',
    quote: 'Yet preference connection unpleasant yet melancholy but end appearance. And excellence partiality estimating terminated day everything.',
    rating: 5,
  },
  {
    name: 'Michael Brown',
    role: 'Director @ Artisan Co',
    quote: 'Yet preference connection unpleasant yet melancholy but end appearance. And excellence partiality estimating terminated day everything.',
    rating: 5,
  },
  {
    name: 'Emma Wilson',
    role: 'Partner @ Design Studio',
    quote: 'Yet preference connection unpleasant yet melancholy but end appearance. And excellence partiality estimating terminated day everything.',
    rating: 5,
  },
];
---

<section id="about" class="py-16 lg:py-24 bg-white">
  <Container maxWidth="screen-2xl">
    <!-- Section Header -->
    <div class="text-center mb-8 lg:mb-16 max-w-2xl mx-auto">
      <h2 class="text-2xl lg:text-4xl font-bold mb-4 uppercase text-brand-primary" style="font-family: 'Montserrat', sans-serif;">
        {t.testimonials.title}
      </h2>
      <p class="text-gray-600" style="font-family: 'Montserrat', sans-serif;">
        {t.testimonials.description}
      </p>
    </div>

    <!-- Testimonials Carousel Container -->
    <div class="relative">
      <!-- Blue Background Block -->
      <div class="blue-background-block absolute left-4 right-4 lg:left-6 lg:right-6 bg-brand-primary"></div>

      <!-- Carousel Wrapper -->
      <div class="relative carousel-wrapper">
        <!-- Testimonials Carousel -->
        <div class="testimonials-carousel px-2 lg:px-0">
          <div class="testimonials-track flex items-center transition-transform duration-500 ease-in-out" id="testimonials-track">
            {testimonials.map((testimonial, index) => (
              <div class="testimonial-slide flex-shrink-0 w-full md:w-1/2 lg:w-1/3 px-3">
                <TestimonialCard
                  name={testimonial.name}
                  role={testimonial.role}
                  quote={testimonial.quote}
                  rating={testimonial.rating}
                />
              </div>
            ))}
          </div>
        </div>

        <!-- Navigation Arrows -->
        <div class="flex justify-center mt-4 pb-8 relative z-10">
          <div class="nav-controls inline-flex bg-white rounded-xl overflow-hidden shadow-lg p-1">
            <!-- Left Arrow Button -->
            <button
              id="prev-btn"
              class="nav-arrow-btn left-arrow w-12 h-12 flex items-center justify-center transition-all duration-300"
              aria-label={t.testimonials.prevButton}
              disabled
            >
              <img
                src="/images/Landing/arrow.svg"
                alt="Previous"
                class="nav-arrow-img w-5 h-auto rotate-180"
                id="prev-arrow-img"
              />
            </button>
            <!-- Right Arrow Button -->
            <button
              id="next-btn"
              class="nav-arrow-btn right-arrow w-12 h-12 flex items-center justify-center rounded-lg transition-all duration-300 bg-accent-red"
              aria-label={t.testimonials.nextButton}
            >
              <img
                src="/images/Landing/arrow.svg"
                alt="Next"
                class="nav-arrow-img w-5 h-auto"
                id="next-arrow-img"
              />
            </button>
          </div>
        </div>
      </div>
    </div>
  </Container>
</section>

<style>
  .blue-background-block {
    top: 0;
    bottom: 0;
    border-radius: 1.5rem 1.5rem 1.5rem 1.5rem;
  }

  .carousel-wrapper {
    padding-top: 80px;
    padding-bottom: 20px;
  }

  .testimonials-carousel {
    margin: 0 -12px;
    padding: 20px 0;
    position: relative;
    z-index: 5;
    overflow-x: clip;
    overflow-y: visible;
  }

  .testimonials-track {
    min-height: 280px;
  }

  .testimonial-slide {
    padding: 0 12px;
  }

  .nav-controls {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .nav-arrow-btn {
    cursor: pointer;
  }

  .nav-arrow-btn:disabled {
    cursor: not-allowed;
  }

  .nav-arrow-btn:not(:disabled):hover {
    opacity: 0.9;
  }

  /* Left arrow styling when inactive (gray) */
  .left-arrow {
    background-color: transparent;
  }

  /* SVG is white by default, so we need to make it gray when inactive */
  .left-arrow .nav-arrow-img {
    filter: brightness(0) saturate(100%) invert(50%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(90%) contrast(90%);
  }

  .left-arrow:disabled .nav-arrow-img {
    filter: brightness(0) saturate(100%) invert(70%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(90%) contrast(90%);
    opacity: 0.5;
  }

  /* Left arrow styling when active (red background, white arrow) */
  .left-arrow.active {
    background-color: var(--color-accent-red);
    border-radius: 0.5rem;
  }

  .left-arrow.active .nav-arrow-img {
    filter: none;
  }

  /* Right arrow styling when active (red background) */
  .right-arrow {
    background-color: var(--color-accent-red);
  }

  /* White arrow on red background - no filter needed */
  .right-arrow .nav-arrow-img {
    filter: none;
  }

  /* Right arrow styling when inactive */
  .right-arrow.inactive {
    background-color: transparent !important;
  }

  .right-arrow.inactive .nav-arrow-img {
    filter: brightness(0) saturate(100%) invert(70%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(90%) contrast(90%);
    opacity: 0.5;
  }
</style>

<script>
  import { debounce } from '../../utils/debounce';

  document.addEventListener('DOMContentLoaded', () => {
    const track = document.getElementById('testimonials-track') as HTMLElement;
    const prevBtn = document.getElementById('prev-btn') as HTMLButtonElement;
    const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;

    if (!track || !prevBtn || !nextBtn) return;

    // Debounced resize handler reference for cleanup
    let debouncedResizeHandler: ((() => void) & { cancel: () => void }) | null = null;

    const slides = track.querySelectorAll('.testimonial-slide');
    const totalSlides = slides.length;
    let currentIndex = 0;

    // Determine visible slides based on screen width
    const getVisibleSlides = () => {
      if (window.innerWidth >= 1024) return 3;
      if (window.innerWidth >= 768) return 2;
      return 1;
    };

    const updateCarousel = () => {
      const visibleSlides = getVisibleSlides();
      const maxIndex = Math.max(0, totalSlides - visibleSlides);

      // Clamp currentIndex
      currentIndex = Math.max(0, Math.min(currentIndex, maxIndex));

      // Calculate slide width percentage
      const slideWidthPercent = 100 / visibleSlides;
      const translateX = -currentIndex * slideWidthPercent;

      track.style.transform = `translateX(${translateX}%)`;

      // Update button states and styling
      const canGoPrev = currentIndex > 0;
      const canGoNext = currentIndex < maxIndex;

      prevBtn.disabled = !canGoPrev;
      nextBtn.disabled = !canGoNext;

      // Update left button styling
      if (canGoPrev) {
        prevBtn.classList.add('active');
      } else {
        prevBtn.classList.remove('active');
      }

      // Update right button styling
      if (canGoNext) {
        nextBtn.classList.remove('inactive');
      } else {
        nextBtn.classList.add('inactive');
      }
    };

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateCarousel();
      }
    });

    nextBtn.addEventListener('click', () => {
      const visibleSlides = getVisibleSlides();
      const maxIndex = Math.max(0, totalSlides - visibleSlides);
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateCarousel();
      }
    });

    // Handle window resize with debouncing to prevent excessive recalculations
    // Using 200ms delay as resize events fire rapidly during window resizing
    debouncedResizeHandler = debounce(updateCarousel, 200);
    window.addEventListener('resize', debouncedResizeHandler);

    // Initial update
    updateCarousel();

    // Cleanup function for when component is unmounted (SPA navigation)
    function cleanup() {
      if (debouncedResizeHandler) {
        window.removeEventListener('resize', debouncedResizeHandler);
        debouncedResizeHandler.cancel();
        debouncedResizeHandler = null;
      }
    }

    // Listen for Astro page transitions to cleanup
    document.addEventListener('astro:before-swap', cleanup, { once: true });
  });
</script>
