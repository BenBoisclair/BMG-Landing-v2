---
import { useI18n } from '../../i18n/utils';

const { t } = useI18n(Astro.url);
---

<section class="py-16 lg:py-24 bg-white" id="price-estimation">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <h2 class="text-3xl lg:text-4xl font-bold text-center mb-8 text-brand-primary">
      {t.priceEstimation.title}
    </h2>

    <!-- Tab Container -->
    <div class="w-full">
      <!-- Tab Buttons -->
      <div class="flex rounded-lg overflow-hidden border-2 border-brand-dark" role="tablist" aria-label="Price estimation calculator type">
        <button
          id="bust-tab"
          role="tab"
          aria-selected="false"
          aria-controls="bust-panel"
          class="flex-1 py-4 px-6 text-xl lg:text-2xl font-semibold text-white bg-brand-medium hover:bg-brand-medium-hover transition-all duration-300 ease-out focus:outline-none focus:ring-2 focus:ring-brand-dark focus:ring-offset-2"
          data-tab="bust"
        >
          {t.priceEstimation.bust.tab}
        </button>
        <button
          id="relief-tab"
          role="tab"
          aria-selected="false"
          aria-controls="relief-panel"
          class="flex-1 py-4 px-6 text-xl lg:text-2xl font-semibold text-white bg-brand-medium hover:bg-brand-medium-hover transition-all duration-300 ease-out focus:outline-none focus:ring-2 focus:ring-brand-dark focus:ring-offset-2"
          data-tab="relief"
        >
          {t.priceEstimation.relief.tab}
        </button>
      </div>

      <!-- Tab Panels -->
      <!-- Bust Calculator Panel -->
      <div
        id="bust-panel"
        role="tabpanel"
        aria-labelledby="bust-tab"
        class="mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden"
      >
        <h3 class="text-xl font-semibold text-brand-dark mb-4">{t.priceEstimation.bust.title}</h3>

        <!-- Stone Grade Selection -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">{t.priceEstimation.stoneGrade}</label>
          <div class="grid grid-cols-3 gap-3" role="radiogroup" aria-label={t.priceEstimation.stoneGrade}>
            <button class="bust-grade-btn px-4 py-3 border-2 border-brand-dark rounded-lg text-brand-dark hover:bg-brand-dark hover:text-white transition-colors" data-grade="A" data-price="0.10" role="radio" aria-checked="false">
              <span class="block font-semibold">{t.priceEstimation.grades.a.label}</span>
              <span class="block text-sm opacity-75">{t.priceEstimation.grades.a.description}</span>
            </button>
            <button class="bust-grade-btn px-4 py-3 border-2 border-brand-dark rounded-lg text-brand-dark hover:bg-brand-dark hover:text-white transition-colors" data-grade="AA" data-price="0.15" role="radio" aria-checked="false">
              <span class="block font-semibold">{t.priceEstimation.grades.aa.label}</span>
              <span class="block text-sm opacity-75">{t.priceEstimation.grades.aa.description}</span>
            </button>
            <button class="bust-grade-btn px-4 py-3 border-2 border-brand-dark rounded-lg text-brand-dark hover:bg-brand-dark hover:text-white transition-colors" data-grade="AA+" data-price="0.25" role="radio" aria-checked="false">
              <span class="block font-semibold">{t.priceEstimation.grades.aaPlus.label}</span>
              <span class="block text-sm opacity-75">{t.priceEstimation.grades.aaPlus.description}</span>
            </button>
          </div>
        </div>

        <!-- Dimension Inputs -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">{t.priceEstimation.dimensions}</label>
          <div class="grid grid-cols-3 gap-4">
            <!-- Length Input -->
            <div class="dimension-input-group">
              <label for="bust-length" class="block text-xs text-gray-500 mb-1">{t.priceEstimation.length}</label>
              <div class="relative">
                <input
                  type="number"
                  id="bust-length"
                  name="bust-length"
                  min="1"
                  max="50"
                  step="0.1"
                  class="dimension-input w-full h-12 px-3 pr-10 border-2 border-gray-300 rounded-lg text-lg font-semibold text-center focus:outline-none focus:border-brand-dark focus:ring-2 focus:ring-brand-dark/20 transition-colors"
                  placeholder="0"
                  aria-describedby="bust-length-unit"
                />
                <span id="bust-length-unit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">cm</span>
              </div>
            </div>
            <!-- Width Input -->
            <div class="dimension-input-group">
              <label for="bust-width" class="block text-xs text-gray-500 mb-1">{t.priceEstimation.width}</label>
              <div class="relative">
                <input
                  type="number"
                  id="bust-width"
                  name="bust-width"
                  min="1"
                  max="50"
                  step="0.1"
                  class="dimension-input w-full h-12 px-3 pr-10 border-2 border-gray-300 rounded-lg text-lg font-semibold text-center focus:outline-none focus:border-brand-dark focus:ring-2 focus:ring-brand-dark/20 transition-colors"
                  placeholder="0"
                  aria-describedby="bust-width-unit"
                />
                <span id="bust-width-unit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">cm</span>
              </div>
            </div>
            <!-- Height Input -->
            <div class="dimension-input-group">
              <label for="bust-height" class="block text-xs text-gray-500 mb-1">{t.priceEstimation.height}</label>
              <div class="relative">
                <input
                  type="number"
                  id="bust-height"
                  name="bust-height"
                  min="1"
                  max="50"
                  step="0.1"
                  class="dimension-input w-full h-12 px-3 pr-10 border-2 border-gray-300 rounded-lg text-lg font-semibold text-center focus:outline-none focus:border-brand-dark focus:ring-2 focus:ring-brand-dark/20 transition-colors"
                  placeholder="0"
                  aria-describedby="bust-height-unit"
                />
                <span id="bust-height-unit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">cm</span>
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">{t.priceEstimation.bust.maxDimensions}</p>
        </div>

        <!-- Volume Display -->
        <div class="mb-4 p-3 bg-gray-100 rounded-lg">
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600">{t.priceEstimation.volume}</span>
            <span id="bust-volume" class="font-medium text-brand-dark">0 cm続</span>
          </div>
        </div>

        <!-- Estimated Price Display -->
        <div class="mt-8 p-4 bg-brand-dark rounded-lg text-center">
          <p class="text-white text-sm mb-1">{t.priceEstimation.estimatedPrice}</p>
          <p id="bust-price" class="text-3xl font-bold text-white" data-select-grade={t.priceEstimation.selectGrade} data-enter-dimensions={t.priceEstimation.enterDimensions}>{t.priceEstimation.selectGrade}</p>
          <p class="text-white/70 text-xs mt-2">{t.priceEstimation.priceDisclaimer}</p>
        </div>

        <!-- Contact CTA -->
        <div class="mt-4 text-center">
          <a href="#contact" class="inline-block px-8 py-3 bg-bmg-gold text-white font-semibold rounded-lg hover:bg-bmg-gold/90 transition-colors">
            {t.priceEstimation.getCustomQuote}
          </a>
        </div>
      </div>

      <!-- Relief Calculator Panel -->
      <div
        id="relief-panel"
        role="tabpanel"
        aria-labelledby="relief-tab"
        class="mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden"
      >
        <h3 class="text-xl font-semibold text-brand-dark mb-4">{t.priceEstimation.relief.title}</h3>

        <!-- Stone Grade Selection -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">{t.priceEstimation.stoneGrade}</label>
          <div class="grid grid-cols-3 gap-3" role="radiogroup" aria-label={t.priceEstimation.stoneGrade}>
            <button class="relief-grade-btn px-4 py-3 border-2 border-brand-dark rounded-lg text-brand-dark hover:bg-brand-dark hover:text-white transition-colors" data-grade="A" data-price="0.10" role="radio" aria-checked="false">
              <span class="block font-semibold">{t.priceEstimation.grades.a.label}</span>
              <span class="block text-sm opacity-75">{t.priceEstimation.grades.a.description}</span>
            </button>
            <button class="relief-grade-btn px-4 py-3 border-2 border-brand-dark rounded-lg text-brand-dark hover:bg-brand-dark hover:text-white transition-colors" data-grade="AA" data-price="0.15" role="radio" aria-checked="false">
              <span class="block font-semibold">{t.priceEstimation.grades.aa.label}</span>
              <span class="block text-sm opacity-75">{t.priceEstimation.grades.aa.description}</span>
            </button>
            <button class="relief-grade-btn px-4 py-3 border-2 border-brand-dark rounded-lg text-brand-dark hover:bg-brand-dark hover:text-white transition-colors" data-grade="AA+" data-price="0.25" role="radio" aria-checked="false">
              <span class="block font-semibold">{t.priceEstimation.grades.aaPlus.label}</span>
              <span class="block text-sm opacity-75">{t.priceEstimation.grades.aaPlus.description}</span>
            </button>
          </div>
        </div>

        <!-- Dimension Inputs -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">{t.priceEstimation.dimensions}</label>
          <div class="grid grid-cols-3 gap-4">
            <!-- Length Input -->
            <div class="dimension-input-group">
              <label for="relief-length" class="block text-xs text-gray-500 mb-1">{t.priceEstimation.length}</label>
              <div class="relative">
                <input
                  type="number"
                  id="relief-length"
                  name="relief-length"
                  min="1"
                  max="50"
                  step="0.1"
                  class="dimension-input w-full h-12 px-3 pr-10 border-2 border-gray-300 rounded-lg text-lg font-semibold text-center focus:outline-none focus:border-brand-dark focus:ring-2 focus:ring-brand-dark/20 transition-colors"
                  placeholder="0"
                  aria-describedby="relief-length-unit"
                />
                <span id="relief-length-unit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">cm</span>
              </div>
            </div>
            <!-- Width Input -->
            <div class="dimension-input-group">
              <label for="relief-width" class="block text-xs text-gray-500 mb-1">{t.priceEstimation.width}</label>
              <div class="relative">
                <input
                  type="number"
                  id="relief-width"
                  name="relief-width"
                  min="1"
                  max="50"
                  step="0.1"
                  class="dimension-input w-full h-12 px-3 pr-10 border-2 border-gray-300 rounded-lg text-lg font-semibold text-center focus:outline-none focus:border-brand-dark focus:ring-2 focus:ring-brand-dark/20 transition-colors"
                  placeholder="0"
                  aria-describedby="relief-width-unit"
                />
                <span id="relief-width-unit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">cm</span>
              </div>
            </div>
            <!-- Height Input -->
            <div class="dimension-input-group">
              <label for="relief-height" class="block text-xs text-gray-500 mb-1">{t.priceEstimation.height}</label>
              <div class="relative">
                <input
                  type="number"
                  id="relief-height"
                  name="relief-height"
                  min="1"
                  max="30"
                  step="0.1"
                  class="dimension-input w-full h-12 px-3 pr-10 border-2 border-gray-300 rounded-lg text-lg font-semibold text-center focus:outline-none focus:border-brand-dark focus:ring-2 focus:ring-brand-dark/20 transition-colors"
                  placeholder="0"
                  aria-describedby="relief-height-unit"
                />
                <span id="relief-height-unit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">cm</span>
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">{t.priceEstimation.relief.maxDimensions}</p>
        </div>

        <!-- Volume Display -->
        <div class="mb-4 p-3 bg-gray-100 rounded-lg">
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600">{t.priceEstimation.volume}</span>
            <span id="relief-volume" class="font-medium text-brand-dark">0 cm続</span>
          </div>
        </div>

        <!-- Estimated Price Display -->
        <div class="mt-8 p-4 bg-brand-dark rounded-lg text-center">
          <p class="text-white text-sm mb-1">{t.priceEstimation.estimatedPrice}</p>
          <p id="relief-price" class="text-3xl font-bold text-white" data-select-grade={t.priceEstimation.selectGrade} data-enter-dimensions={t.priceEstimation.enterDimensions}>{t.priceEstimation.selectGrade}</p>
          <p class="text-white/70 text-xs mt-2">{t.priceEstimation.priceDisclaimer}</p>
        </div>

        <!-- Contact CTA -->
        <div class="mt-4 text-center">
          <a href="#contact" class="inline-block px-8 py-3 bg-bmg-gold text-white font-semibold rounded-lg hover:bg-bmg-gold/90 transition-colors">
            {t.priceEstimation.getCustomQuote}
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Configuration
  const CALCULATOR_CONFIG = {
    bust: {
      maxLength: 50,
      maxWidth: 50,
      maxHeight: 50,
    },
    relief: {
      maxLength: 50,
      maxWidth: 50,
      maxHeight: 30,
    },
    grades: {
      'A': 0.10,
      'AA': 0.15,
      'AA+': 0.25,
    },
  };

  // Tab switching functionality
  document.addEventListener('DOMContentLoaded', () => {
    const bustTab = document.getElementById('bust-tab');
    const reliefTab = document.getElementById('relief-tab');
    const bustPanel = document.getElementById('bust-panel');
    const reliefPanel = document.getElementById('relief-panel');

    function switchTab(activeTab: string) {
      if (activeTab === 'bust') {
        bustTab?.classList.remove('bg-brand-medium', 'hover:bg-brand-medium-hover');
        bustTab?.classList.add('bg-brand-dark');
        bustTab?.setAttribute('aria-selected', 'true');

        reliefTab?.classList.remove('bg-brand-dark');
        reliefTab?.classList.add('bg-brand-medium', 'hover:bg-brand-medium-hover');
        reliefTab?.setAttribute('aria-selected', 'false');

        bustPanel?.classList.remove('hidden');
        reliefPanel?.classList.add('hidden');
      } else {
        reliefTab?.classList.remove('bg-brand-medium', 'hover:bg-brand-medium-hover');
        reliefTab?.classList.add('bg-brand-dark');
        reliefTab?.setAttribute('aria-selected', 'true');

        bustTab?.classList.remove('bg-brand-dark');
        bustTab?.classList.add('bg-brand-medium', 'hover:bg-brand-medium-hover');
        bustTab?.setAttribute('aria-selected', 'false');

        reliefPanel?.classList.remove('hidden');
        bustPanel?.classList.add('hidden');
      }
    }

    bustTab?.addEventListener('click', () => switchTab('bust'));
    reliefTab?.addEventListener('click', () => switchTab('relief'));

    // Keyboard navigation for tabs
    [bustTab, reliefTab].forEach(tab => {
      tab?.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
          e.preventDefault();
          const currentTab = e.key === 'ArrowRight' ? 'relief' : 'bust';
          switchTab(currentTab);
          (currentTab === 'bust' ? bustTab : reliefTab)?.focus();
        }
      });
    });

    // Calculator State
    interface CalculatorState {
      grade: string | null;
      pricePerCm3: number;
      length: number;
      width: number;
      height: number;
    }

    let bustState: CalculatorState = { grade: null, pricePerCm3: 0, length: 0, width: 0, height: 0 };
    let reliefState: CalculatorState = { grade: null, pricePerCm3: 0, length: 0, width: 0, height: 0 };

    // Update calculation and display
    function updateCalculation(type: 'bust' | 'relief') {
      const state = type === 'bust' ? bustState : reliefState;
      const priceEl = document.getElementById(`${type}-price`);
      const volumeEl = document.getElementById(`${type}-volume`);

      // Calculate volume
      const volume = state.length * state.width * state.height;

      // Update volume display
      if (volumeEl) {
        volumeEl.textContent = volume > 0 ? `${volume.toLocaleString()} cm続` : '0 cm続';
      }

      // Calculate and display price
      if (priceEl) {
        if (state.grade === null) {
          priceEl.textContent = priceEl.dataset.selectGrade || 'Select a stone grade';
        } else if (volume <= 0) {
          priceEl.textContent = priceEl.dataset.enterDimensions || 'Enter dimensions';
        } else {
          const price = volume * state.pricePerCm3;
          priceEl.textContent = `$${price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
      }
    }

    // Setup grade buttons
    function setupGradeButtons(type: 'bust' | 'relief') {
      const state = type === 'bust' ? bustState : reliefState;
      const buttons = document.querySelectorAll(`.${type}-grade-btn`);

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          // Remove active state from all buttons
          buttons.forEach((b) => {
            b.classList.remove('bg-brand-dark', 'text-white');
            b.classList.add('text-brand-dark');
            b.setAttribute('aria-checked', 'false');
          });

          // Add active state to clicked button
          btn.classList.add('bg-brand-dark', 'text-white');
          btn.classList.remove('text-brand-dark');
          btn.setAttribute('aria-checked', 'true');

          // Update state
          const btnEl = btn as HTMLElement;
          state.grade = btnEl.dataset.grade || null;
          state.pricePerCm3 = parseFloat(btnEl.dataset.price || '0');

          updateCalculation(type);
        });

        // Keyboard navigation for grade buttons
        btn.addEventListener('keydown', (e: KeyboardEvent) => {
          if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
            e.preventDefault();
            const btnsArray = Array.from(buttons);
            const currentIndex = btnsArray.indexOf(btn);
            let newIndex: number;

            if (e.key === 'ArrowRight') {
              newIndex = (currentIndex + 1) % btnsArray.length;
            } else {
              newIndex = (currentIndex - 1 + btnsArray.length) % btnsArray.length;
            }

            (btnsArray[newIndex] as HTMLElement).click();
            (btnsArray[newIndex] as HTMLElement).focus();
          }
        });
      });
    }

    // Setup dimension inputs
    function setupDimensionInputs(type: 'bust' | 'relief') {
      const state = type === 'bust' ? bustState : reliefState;
      const config = CALCULATOR_CONFIG[type];

      const dimensions = ['length', 'width', 'height'] as const;

      dimensions.forEach((dim) => {
        const input = document.getElementById(`${type}-${dim}`) as HTMLInputElement;
        if (!input) return;

        const maxKey = `max${dim.charAt(0).toUpperCase() + dim.slice(1)}` as keyof typeof config;
        const max = config[maxKey];

        // Set max attribute
        input.max = String(max);

        // Input event for real-time updates
        input.addEventListener('input', () => {
          let value = parseFloat(input.value) || 0;

          // Clamp to max
          if (value > max) {
            value = max;
            input.value = String(max);
          }

          // Update state
          state[dim] = Math.max(0, value);

          // Visual validation
          if (value > 0 && value <= max) {
            input.classList.remove('border-red-500');
            input.classList.add('border-green-500');
          } else if (value > max) {
            input.classList.remove('border-green-500');
            input.classList.add('border-red-500');
          } else {
            input.classList.remove('border-green-500', 'border-red-500');
          }

          updateCalculation(type);
        });

        // Blur event for final validation
        input.addEventListener('blur', () => {
          const value = parseFloat(input.value) || 0;
          if (value > max) {
            input.value = String(max);
            state[dim] = max;
            updateCalculation(type);
          }
          // Reset border color on blur if valid
          if (value > 0 && value <= max) {
            input.classList.remove('border-red-500');
            input.classList.add('border-gray-300');
          }
        });
      });
    }

    // Initialize calculators
    setupGradeButtons('bust');
    setupGradeButtons('relief');
    setupDimensionInputs('bust');
    setupDimensionInputs('relief');

    // Initialize first tab
    switchTab('bust');
  });
</script>
