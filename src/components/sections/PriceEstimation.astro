---
import { useI18n } from '../../i18n/utils';

const { t, lang } = useI18n(Astro.url);

// Image paths for stone grades
const stoneImages = {
  aPlusPlus: '/images/26d483a8073164eff5528e49cd44d914e594b8e5.png',
  aPlus: '/images/c267197a2cfe6eb447d0bc2c28a0208a6d93b89e.png',
  a: '/images/a04e88f2456f5503d20950b28dd386f0f8b55b3b.png',
};

// Image paths for detail levels
const detailImages = {
  minimal: '/images/13ba63e01b4af986d598682d96e0f684ab188e70.png',
  refine: '/images/13ba63e01b4af986d598682d96e0f684ab188e70.png', // Using minimal as placeholder
  realistic: '/images/e1c52a1a4e99255d1ee041a902eb29a962d3d593.png',
};

// Materials page link based on language
const materialsLink = lang === 'en' ? '/materials' : `/${lang}/materials`;
---

<section class="py-16 lg:py-24 bg-gray-50" id="price-estimation">
  <div class="max-w-[896px] mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="text-center mb-8">
      <h2 class="text-3xl lg:text-4xl font-bold text-brand-primary mb-4">
        {t.priceEstimation.title}
      </h2>
      <p class="text-gray-600 text-base lg:text-lg max-w-2xl mx-auto">
        {t.priceEstimation.subtitle}
      </p>
    </div>

    <!-- Main Calculator Card -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden" data-calculator>
      <!-- Tab Header -->
      <div class="flex border-b border-brand-medium/30" role="tablist" aria-label="Sculpture type">
        <button
          id="bust-tab"
          role="tab"
          aria-selected="true"
          aria-controls="bust-panel"
          class="flex-1 h-[76px] text-xl font-extrabold text-white bg-brand-primary transition-all duration-300 focus:outline-none"
          data-tab="bust"
        >
          {t.priceEstimation.bust.tab}
        </button>
        <button
          id="relief-tab"
          role="tab"
          aria-selected="false"
          aria-controls="relief-panel"
          class="flex-1 h-[76px] text-xl font-extrabold text-white bg-[#9b96d3] hover:bg-[#8a85c2] transition-all duration-300 focus:outline-none"
          data-tab="relief"
        >
          {t.priceEstimation.relief.tab}
        </button>
      </div>

      <!-- Calculator Content -->
      <div class="p-6 lg:p-8 space-y-8">
        <!-- Step 1: Dimensions -->
        <div class="space-y-4" data-step="dimensions">
          <h3 class="text-base font-normal text-gray-800">
            {t.priceEstimation.steps.dimensions.title}
          </h3>

          <!-- Dimension Inputs -->
          <div class="grid grid-cols-3 gap-4">
            <!-- Height -->
            <div class="space-y-2">
              <label for="dimension-height" class="block text-sm text-gray-600">
                {t.priceEstimation.steps.dimensions.height}
              </label>
              <input
                type="number"
                id="dimension-height"
                name="height"
                min="1"
                max="3000"
                placeholder="e.g., 600"
                class="dimension-input w-full h-[50px] px-4 border border-gray-300 rounded-lg text-base focus:outline-none focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20 transition-colors"
                data-dimension="height"
              />
              <p class="text-xs text-gray-500">{t.priceEstimation.steps.dimensions.maxHint}</p>
            </div>

            <!-- Width -->
            <div class="space-y-2">
              <label for="dimension-width" class="block text-sm text-gray-600">
                {t.priceEstimation.steps.dimensions.width}
              </label>
              <input
                type="number"
                id="dimension-width"
                name="width"
                min="1"
                max="3000"
                placeholder="e.g., 450"
                class="dimension-input w-full h-[50px] px-4 border border-gray-300 rounded-lg text-base focus:outline-none focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20 transition-colors"
                data-dimension="width"
              />
              <p class="text-xs text-gray-500">{t.priceEstimation.steps.dimensions.maxHint}</p>
            </div>

            <!-- Depth -->
            <div class="space-y-2">
              <label for="dimension-depth" class="block text-sm text-gray-600">
                {t.priceEstimation.steps.dimensions.depth}
              </label>
              <input
                type="number"
                id="dimension-depth"
                name="depth"
                min="1"
                max="3000"
                placeholder="e.g., 300"
                class="dimension-input w-full h-[50px] px-4 border border-gray-300 rounded-lg text-base focus:outline-none focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20 transition-colors"
                data-dimension="depth"
              />
              <p class="text-xs text-gray-500">{t.priceEstimation.steps.dimensions.maxHint}</p>
            </div>
          </div>

          <!-- Remark Box -->
          <div class="bg-[#fff6f6] border-l-4 border-accent-red rounded-r px-4 py-3">
            <p class="text-sm text-accent-red" set:html={t.priceEstimation.steps.dimensions.remark}></p>
          </div>
        </div>

        <!-- Step 2: Stone Category -->
        <div class="space-y-4" data-step="stone">
          <h3 class="text-base font-normal text-gray-800">
            {t.priceEstimation.steps.stoneCategory.title}
          </h3>

          <!-- Stone Grade Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" role="radiogroup" aria-label="Stone category">
            <!-- A++ Semi-Precious -->
            <button
              type="button"
              class="stone-card group bg-white border-2 border-gray-300 rounded-lg overflow-hidden transition-all duration-200 hover:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2"
              data-stone="aPlusPlus"
              data-price="0.00025"
              role="radio"
              aria-checked="false"
            >
              <div class="h-32 overflow-hidden">
                <img
                  src={stoneImages.aPlusPlus}
                  alt="A++ Semi-Precious stone"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
              </div>
              <div class="p-4 text-center">
                <p class="text-base text-gray-700 font-normal">{t.priceEstimation.steps.stoneCategory.grades.aPlusPlus.label}</p>
                <p class="text-sm text-gray-500 opacity-75">{t.priceEstimation.steps.stoneCategory.grades.aPlusPlus.description}</p>
              </div>
            </button>

            <!-- A+ Luxury -->
            <button
              type="button"
              class="stone-card group bg-white border-2 border-gray-300 rounded-lg overflow-hidden transition-all duration-200 hover:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2"
              data-stone="aPlus"
              data-price="0.00015"
              role="radio"
              aria-checked="false"
            >
              <div class="h-32 overflow-hidden">
                <img
                  src={stoneImages.aPlus}
                  alt="A+ Luxury stone"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
              </div>
              <div class="p-4 text-center">
                <p class="text-base text-gray-700 font-normal">{t.priceEstimation.steps.stoneCategory.grades.aPlus.label}</p>
                <p class="text-sm text-gray-500 opacity-75">{t.priceEstimation.steps.stoneCategory.grades.aPlus.description}</p>
              </div>
            </button>

            <!-- A Classic -->
            <button
              type="button"
              class="stone-card group bg-white border-2 border-gray-300 rounded-lg overflow-hidden transition-all duration-200 hover:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2"
              data-stone="a"
              data-price="0.00010"
              role="radio"
              aria-checked="false"
            >
              <div class="h-32 overflow-hidden">
                <img
                  src={stoneImages.a}
                  alt="A Classic Granite stone"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
              </div>
              <div class="p-4 text-center">
                <p class="text-base text-gray-700 font-normal">{t.priceEstimation.steps.stoneCategory.grades.a.label}</p>
                <p class="text-sm text-gray-500 opacity-75">{t.priceEstimation.steps.stoneCategory.grades.a.description}</p>
              </div>
            </button>
          </div>

          <!-- Help Box -->
          <div class="bg-[#fef2f2] border-l-4 border-accent-red rounded-r px-4 py-3">
            <p class="text-sm text-[#9f0712]">
              <span set:html={t.priceEstimation.steps.stoneCategory.help.split('Visit')[0]}></span>
              <a href={materialsLink} class="underline hover:no-underline">Visit our Materials Page</a>
              {t.priceEstimation.steps.stoneCategory.help.split('Materials Page')[1]?.replace('</strong>', '') || ' to learn more about stone categories and find the right grade for your project.'}
            </p>
          </div>
        </div>

        <!-- Step 3: Detail Level -->
        <div class="space-y-4" data-step="detail">
          <h3 class="text-base font-normal text-gray-800">
            {t.priceEstimation.steps.detailLevel.title}
          </h3>

          <!-- Detail Level Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" role="radiogroup" aria-label="Detail level">
            <!-- Minimal -->
            <button
              type="button"
              class="detail-card group bg-white border-2 border-gray-300 rounded-lg overflow-hidden transition-all duration-200 hover:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2"
              data-detail="minimal"
              data-addition="0"
              role="radio"
              aria-checked="false"
            >
              <div class="h-32 overflow-hidden">
                <img
                  src={detailImages.minimal}
                  alt="Minimal detail sculpture"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
              </div>
              <div class="p-4 text-left">
                <p class="text-base text-gray-800 font-normal mb-2">{t.priceEstimation.steps.detailLevel.levels.minimal.label}</p>
                <p class="text-sm text-gray-600 leading-5">{t.priceEstimation.steps.detailLevel.levels.minimal.description}</p>
              </div>
            </button>

            <!-- Refine -->
            <button
              type="button"
              class="detail-card group bg-white border-2 border-gray-300 rounded-lg overflow-hidden transition-all duration-200 hover:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2"
              data-detail="refine"
              data-addition="500"
              role="radio"
              aria-checked="false"
            >
              <div class="h-32 overflow-hidden relative">
                <img
                  src={detailImages.refine}
                  alt="Refine detail sculpture"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
                <div class="absolute inset-0 bg-black/20"></div>
              </div>
              <div class="p-4 text-left">
                <p class="text-base text-gray-800 font-normal mb-2">{t.priceEstimation.steps.detailLevel.levels.refine.label}</p>
                <p class="text-sm text-gray-600 leading-5">{t.priceEstimation.steps.detailLevel.levels.refine.description}</p>
              </div>
            </button>

            <!-- Realistic -->
            <button
              type="button"
              class="detail-card group bg-white border-2 border-gray-300 rounded-lg overflow-hidden transition-all duration-200 hover:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2"
              data-detail="realistic"
              data-addition="1500"
              role="radio"
              aria-checked="false"
            >
              <div class="h-32 overflow-hidden">
                <img
                  src={detailImages.realistic}
                  alt="Realistic detail sculpture"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
              </div>
              <div class="p-4 text-left">
                <p class="text-base text-gray-800 font-normal mb-2">{t.priceEstimation.steps.detailLevel.levels.realistic.label}</p>
                <p class="text-sm text-gray-600 leading-5">{t.priceEstimation.steps.detailLevel.levels.realistic.description}</p>
              </div>
            </button>
          </div>
        </div>

        <!-- Calculate Button -->
        <button
          type="button"
          id="calculate-btn"
          disabled
          class="w-full h-14 rounded-lg text-base font-normal transition-all duration-300 bg-gray-300 text-gray-500 cursor-not-allowed disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed enabled:bg-brand-primary enabled:text-white enabled:cursor-pointer enabled:hover:bg-brand-primary/90 flex items-center justify-center gap-2"
          data-calculate
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
          </svg>
          <span>{t.priceEstimation.calculateButton}</span>
        </button>

        <!-- Price Result (Hidden initially) -->
        <div id="price-result" class="hidden mt-6 p-6 bg-brand-primary rounded-lg text-center" aria-live="polite">
          <p class="text-white/80 text-sm mb-2">{t.priceEstimation.estimatedPrice}</p>
          <p id="price-value" class="text-4xl font-bold text-white mb-2">$0.00</p>
          <p class="text-white/60 text-xs">{t.priceEstimation.priceDisclaimer}</p>
        </div>

        <!-- Contact CTA -->
        <div class="text-center pt-4">
          <a
            href="#contact"
            class="inline-block px-8 py-3 bg-bmg-gold text-white font-semibold rounded-lg hover:bg-bmg-gold/90 transition-colors"
          >
            {t.priceEstimation.getCustomQuote}
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // State
    interface CalculatorState {
      activeTab: 'bust' | 'relief';
      dimensions: {
        height: number;
        width: number;
        depth: number;
      };
      stoneGrade: string | null;
      stonePricePerMm3: number;
      detailLevel: string | null;
      detailAddition: number;
    }

    const state: CalculatorState = {
      activeTab: 'bust',
      dimensions: { height: 0, width: 0, depth: 0 },
      stoneGrade: null,
      stonePricePerMm3: 0,
      detailLevel: null,
      detailAddition: 0,
    };

    // Elements
    const bustTab = document.getElementById('bust-tab');
    const reliefTab = document.getElementById('relief-tab');
    const calculateBtn = document.getElementById('calculate-btn');
    const priceResult = document.getElementById('price-result');
    const priceValue = document.getElementById('price-value');
    const dimensionInputs = document.querySelectorAll<HTMLInputElement>('.dimension-input');
    const stoneCards = document.querySelectorAll<HTMLButtonElement>('.stone-card');
    const detailCards = document.querySelectorAll<HTMLButtonElement>('.detail-card');

    // Tab switching
    function switchTab(tab: 'bust' | 'relief') {
      state.activeTab = tab;

      if (tab === 'bust') {
        bustTab?.classList.remove('bg-[#9b96d3]', 'hover:bg-[#8a85c2]');
        bustTab?.classList.add('bg-brand-primary');
        bustTab?.setAttribute('aria-selected', 'true');

        reliefTab?.classList.remove('bg-brand-primary');
        reliefTab?.classList.add('bg-[#9b96d3]', 'hover:bg-[#8a85c2]');
        reliefTab?.setAttribute('aria-selected', 'false');
      } else {
        reliefTab?.classList.remove('bg-[#9b96d3]', 'hover:bg-[#8a85c2]');
        reliefTab?.classList.add('bg-brand-primary');
        reliefTab?.setAttribute('aria-selected', 'true');

        bustTab?.classList.remove('bg-brand-primary');
        bustTab?.classList.add('bg-[#9b96d3]', 'hover:bg-[#8a85c2]');
        bustTab?.setAttribute('aria-selected', 'false');
      }

      updateCalculateButton();
    }

    bustTab?.addEventListener('click', () => switchTab('bust'));
    reliefTab?.addEventListener('click', () => switchTab('relief'));

    // Dimension inputs
    dimensionInputs.forEach((input) => {
      input.addEventListener('input', () => {
        const dimension = input.dataset.dimension as 'height' | 'width' | 'depth';
        let value = parseFloat(input.value) || 0;

        // Clamp to max
        if (value > 3000) {
          value = 3000;
          input.value = '3000';
        }

        state.dimensions[dimension] = Math.max(0, value);

        // Visual validation
        if (value > 0 && value <= 3000) {
          input.classList.remove('border-red-500');
          input.classList.add('border-green-500');
        } else if (value > 3000) {
          input.classList.remove('border-green-500');
          input.classList.add('border-red-500');
        } else {
          input.classList.remove('border-green-500', 'border-red-500');
        }

        updateCalculateButton();
      });
    });

    // Stone card selection
    stoneCards.forEach((card) => {
      card.addEventListener('click', () => {
        // Remove selection from all
        stoneCards.forEach((c) => {
          c.classList.remove('border-brand-primary', 'ring-2', 'ring-brand-primary');
          c.classList.add('border-gray-300');
          c.setAttribute('aria-checked', 'false');
        });

        // Select this card
        card.classList.remove('border-gray-300');
        card.classList.add('border-brand-primary', 'ring-2', 'ring-brand-primary');
        card.setAttribute('aria-checked', 'true');

        state.stoneGrade = card.dataset.stone || null;
        state.stonePricePerMm3 = parseFloat(card.dataset.price || '0');

        updateCalculateButton();
      });

      // Keyboard navigation
      card.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
          e.preventDefault();
          const cards = Array.from(stoneCards);
          const currentIndex = cards.indexOf(card);
          let newIndex: number;

          if (e.key === 'ArrowRight') {
            newIndex = (currentIndex + 1) % cards.length;
          } else {
            newIndex = (currentIndex - 1 + cards.length) % cards.length;
          }

          (cards[newIndex] as HTMLButtonElement).click();
          (cards[newIndex] as HTMLButtonElement).focus();
        }
      });
    });

    // Detail card selection
    detailCards.forEach((card) => {
      card.addEventListener('click', () => {
        // Remove selection from all
        detailCards.forEach((c) => {
          c.classList.remove('border-brand-primary', 'ring-2', 'ring-brand-primary');
          c.classList.add('border-gray-300');
          c.setAttribute('aria-checked', 'false');
        });

        // Select this card
        card.classList.remove('border-gray-300');
        card.classList.add('border-brand-primary', 'ring-2', 'ring-brand-primary');
        card.setAttribute('aria-checked', 'true');

        state.detailLevel = card.dataset.detail || null;
        state.detailAddition = parseFloat(card.dataset.addition || '0');

        updateCalculateButton();
      });

      // Keyboard navigation
      card.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
          e.preventDefault();
          const cards = Array.from(detailCards);
          const currentIndex = cards.indexOf(card);
          let newIndex: number;

          if (e.key === 'ArrowRight') {
            newIndex = (currentIndex + 1) % cards.length;
          } else {
            newIndex = (currentIndex - 1 + cards.length) % cards.length;
          }

          (cards[newIndex] as HTMLButtonElement).click();
          (cards[newIndex] as HTMLButtonElement).focus();
        }
      });
    });

    // Check if all selections are complete
    function isFormComplete(): boolean {
      const { dimensions, stoneGrade, detailLevel } = state;
      return (
        dimensions.height > 0 &&
        dimensions.width > 0 &&
        dimensions.depth > 0 &&
        stoneGrade !== null &&
        detailLevel !== null
      );
    }

    // Update calculate button state
    function updateCalculateButton() {
      if (calculateBtn) {
        if (isFormComplete()) {
          calculateBtn.removeAttribute('disabled');
        } else {
          calculateBtn.setAttribute('disabled', '');
        }
      }
    }

    // Calculate price
    function calculatePrice(): number {
      const { dimensions, stonePricePerMm3, detailAddition } = state;
      const volume = dimensions.height * dimensions.width * dimensions.depth;
      const basePrice = volume * stonePricePerMm3;
      return basePrice + detailAddition;
    }

    // Format price
    function formatPrice(price: number): string {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(price);
    }

    // Calculate button click
    calculateBtn?.addEventListener('click', () => {
      if (!isFormComplete()) return;

      const price = calculatePrice();

      if (priceValue) {
        priceValue.textContent = formatPrice(price);
      }

      priceResult?.classList.remove('hidden');

      // Scroll to result
      priceResult?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });

    // Initialize
    updateCalculateButton();
  });
</script>

<style>
  /* Selected card styles */
  .stone-card[aria-checked="true"],
  .detail-card[aria-checked="true"] {
    border-color: var(--color-brand-primary);
    box-shadow: 0 0 0 2px var(--color-brand-primary);
  }

  /* Input validation states */
  .dimension-input.border-green-500 {
    border-color: #22c55e;
  }

  .dimension-input.border-red-500 {
    border-color: #ef4444;
  }
</style>
