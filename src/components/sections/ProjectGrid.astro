---
import ProjectCard from '../ui/ProjectCard.astro';
import { useI18n, getLocalizedPath } from '../../i18n/utils';
import Container from '../ui/Container.astro';
import { getProjectsGroupedByCategory, type SanityProject } from '../../lib/queries/projects';
import { getLocalizedValue, type Language } from '../../lib/sanity';
import { urlFor } from '../../lib/sanityImage';

const { t, lang } = useI18n(Astro.url);

// Fetch projects from Sanity
const projectsByCategory = await getProjectsGroupedByCategory();

// Project types with their data
const projectTypes = [
  { id: 'religious', projects: projectsByCategory.religious },
  { id: 'legacy', projects: projectsByCategory.legacy },
  { id: 'architectural', projects: projectsByCategory.architectural },
].filter(type => type.projects.length > 0);

// Build category labels from translations
const categoryLabels: Record<string, string> = {
  religious: t.project.types.religious,
  legacy: t.project.types.legacy,
  architectural: t.project.types.architectural,
};

// Helper to get project detail path
const getProjectPath = (projectId: string) => getLocalizedPath(lang, `/projects/${projectId}`);

// Helper to get project name
const getProjectName = (project: SanityProject): string => {
  const sanityName = getLocalizedValue(project.name, lang as Language);
  if (sanityName) return sanityName;

  const projectId = project.internalId?.current || project._id;
  return t.project.projects[projectId as keyof typeof t.project.projects]?.name || projectId;
};

// Helper to get image URL
const getImageUrl = (project: SanityProject): string => {
  if (project.mainImage?.asset) {
    return urlFor(project.mainImage).width(600).height(400).format('webp').url();
  }
  return '/images/placeholder.jpg';
};
---

<section class="py-12 lg:py-16 bg-white">
  <Container>
    {projectTypes.map((projectType, index) => (
      <div class="mb-12 last:mb-0">
        <!-- Section Title -->
        <h2 class="text-3xl lg:text-4xl font-semibold text-brand-primary mb-8 tracking-tight uppercase">
          {t.project.sections[projectType.id as keyof typeof t.project.sections]?.title || categoryLabels[projectType.id]}
        </h2>

        <!-- Swiper Carousel -->
        <div class="project-swiper-container">
          <div class="swiper project-swiper" data-swiper-id={`swiper-${index}`}>
            <div class="swiper-wrapper">
              {projectType.projects.map((project) => {
                const projectId = project.internalId?.current || project._id;
                return (
                  <div class="swiper-slide">
                    <ProjectCard
                      image={getImageUrl(project)}
                      name={getProjectName(project)}
                      categories={[projectType.id]}
                      categoryLabels={categoryLabels}
                      href={getProjectPath(projectId)}
                    />
                  </div>
                );
              })}
            </div>
          </div>

          <!-- Navigation Arrows -->
          <div class="flex gap-4 mt-6">
            <button
              class="swiper-btn-prev p-3 rounded-full bg-brand-primary text-white hover:bg-brand-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label={t.project.pagination.prev}
              data-swiper-target={`swiper-${index}`}
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <button
              class="swiper-btn-next p-3 rounded-full bg-brand-primary text-white hover:bg-brand-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label={t.project.pagination.next}
              data-swiper-target={`swiper-${index}`}
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    ))}
  </Container>
</section>

<script>
  import Swiper from 'swiper';
  import { Navigation } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';

  function initSwipers() {
    const swiperContainers = document.querySelectorAll('.project-swiper');

    swiperContainers.forEach((container) => {
      const swiperId = container.getAttribute('data-swiper-id');
      const parent = container.closest('.project-swiper-container');
      const prevBtn = parent?.querySelector('.swiper-btn-prev');
      const nextBtn = parent?.querySelector('.swiper-btn-next');

      new Swiper(container as HTMLElement, {
        modules: [Navigation],
        slidesPerView: 1.2,
        spaceBetween: 16,
        grabCursor: true,
        navigation: {
          prevEl: prevBtn as HTMLElement,
          nextEl: nextBtn as HTMLElement,
        },
        breakpoints: {
          640: {
            slidesPerView: 2.2,
            spaceBetween: 16,
          },
          1024: {
            slidesPerView: 4,
            spaceBetween: 24,
          },
        },
      });
    });
  }

  // Initialize on page load
  initSwipers();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initSwipers);
</script>

<style is:global>
  .project-swiper .swiper-slide {
    height: auto;
  }
</style>
