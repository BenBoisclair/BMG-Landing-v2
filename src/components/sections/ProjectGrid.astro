---
import ProjectCard from '../ui/ProjectCard.astro';
import { useI18n, getLocalizedPath } from '../../i18n/utils';
import Container from '../ui/Container.astro';
import projectsData from '../../data/projects.json';

const { t, lang } = useI18n(Astro.url);

// Build category labels from translations
const categoryLabels: Record<string, string> = {};
for (const cat of projectsData.categories) {
  categoryLabels[cat] = t.project.types[cat as keyof typeof t.project.types];
}

// Helper to get project detail path
const getProjectPath = (projectId: string) => getLocalizedPath(lang, `/projects/${projectId}`);
---

<section class="py-12 lg:py-16 bg-white">
  <Container>
    {projectsData.projectTypes.map((projectType, index) => (
      <div class="mb-12 last:mb-0">
        <!-- Section Title -->
        <h2 class="text-3xl lg:text-4xl font-semibold text-brand-primary mb-8 tracking-tight uppercase">
          {t.project.sections[projectType.id as keyof typeof t.project.sections].title}
        </h2>

        <!-- Swiper Carousel -->
        <div class="project-swiper-container">
          <div class="swiper project-swiper" data-swiper-id={`swiper-${index}`}>
            <div class="swiper-wrapper">
              {projectType.projects.map((project) => (
                <div class="swiper-slide">
                  <ProjectCard
                    image={project.image}
                    name={t.project.projects[project.id as keyof typeof t.project.projects]?.name || project.id}
                    categories={project.categories}
                    categoryLabels={categoryLabels}
                    href={getProjectPath(project.id)}
                  />
                </div>
              ))}
            </div>
          </div>

          <!-- Navigation Arrows -->
          <div class="flex gap-4 mt-6">
            <button
              class="swiper-btn-prev p-3 rounded-full bg-brand-primary text-white hover:bg-brand-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label={t.project.pagination.prev}
              data-swiper-target={`swiper-${index}`}
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <button
              class="swiper-btn-next p-3 rounded-full bg-brand-primary text-white hover:bg-brand-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label={t.project.pagination.next}
              data-swiper-target={`swiper-${index}`}
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    ))}
  </Container>
</section>

<script>
  import Swiper from 'swiper';
  import { Navigation } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';

  function initSwipers() {
    const swiperContainers = document.querySelectorAll('.project-swiper');

    swiperContainers.forEach((container) => {
      const swiperId = container.getAttribute('data-swiper-id');
      const parent = container.closest('.project-swiper-container');
      const prevBtn = parent?.querySelector('.swiper-btn-prev');
      const nextBtn = parent?.querySelector('.swiper-btn-next');

      new Swiper(container as HTMLElement, {
        modules: [Navigation],
        slidesPerView: 1.2,
        spaceBetween: 16,
        grabCursor: true,
        navigation: {
          prevEl: prevBtn as HTMLElement,
          nextEl: nextBtn as HTMLElement,
        },
        breakpoints: {
          640: {
            slidesPerView: 2.2,
            spaceBetween: 16,
          },
          1024: {
            slidesPerView: 4,
            spaceBetween: 24,
          },
        },
      });
    });
  }

  // Initialize on page load
  initSwipers();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initSwipers);
</script>

<style is:global>
  .project-swiper .swiper-slide {
    height: auto;
  }
</style>
